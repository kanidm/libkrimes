version: "3.8"

services:
  krimedc:
    restart: no
    build:
      context: ../../
      dockerfile: ./examples/samba/Dockerfile.krimedc
    image: libkrimes:kdc
    container_name: libkrimes_kdc
    command: krimedc
    privileged: false
    hostname: krimedc
    domainname: example.com
    dns_search: example.com
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "88"]
      interval: 5s
      timeout: 3s
      retries: 60
    volumes:
      - samba-keytab:/tmp/samba/
    networks:
      static-network:
        ipv4_address: 192.168.238.10
    ports:
      - "88:88"

  samba:
    depends_on:
      krimedc:
        condition: service_healthy
    restart: unless-stopped
    build:
      context: ../../
      dockerfile: ./examples/samba/Dockerfile.samba
    image: libkrimes:smb
    container_name: libkrimes_smb
    command: smbd
    hostname: samba
    domainname: example.com
    dns_search: example.com
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "445" ]
      interval: 5s
      timeout: 3s
      retries: 60
    volumes:
      - samba-keytab:/tmp/samba/
    networks:
      static-network:
        ipv4_address: 192.168.238.11
    ports:
      - "445:445"

  dnsmasq:
    restart: no
    build:
      context: ../../
      dockerfile: ./examples/samba/Dockerfile.dnsmasq
    image: libkrimes:dnsmasq
    container_name: libkrimes_dnsmasq
    hostname: dnsmasq
    domainname: example.com
    dns_search: example.com
    networks:
      static-network:
        ipv4_address: 192.168.238.12
    ports:
      - "53:53/tcp"
      - "53:53/udp"

volumes:
  samba-keytab:

networks:
  static-network:
    ipam:
      config:
        - subnet: 192.168.238.0/24
          gateway: 192.168.238.1
